F.module("/static/widget/lemma/history/notation/notationLogic.js",function(c,a){var d=c("/static/common/ui/jquery/jquery.js");var e=function(){var f={Paragraph:/<\/div>[\s\S]*<div\s+class\s*=\s*['"]?para['"]?/i,Title:/<h[23][^>]+>/i};this.isInValidContainer=function(j){j=d(j);var i=j.attr("class");var h=!!i&&(i.indexOf("card-summary-content")>-1||i.indexOf("baseInfoWrap")>-1||i.indexOf("para")>-1);var g=j.parents(".card-summary-content").length>0||j.parents(".baseInfoWrap").length>0||j.parents(".para").length>0;return h||g};this.isInHead=function(g){g=d(g);return g.parents("h2").length>0||g.parents("h3").length>0};this.isIncludeHead=function(g){return g.search(f.Title)!==-1};this.isIncludeImage=function(h){var g=h.getNodes([1],function(j){var i=j.className;return/lemma\-picture/.test(i)||/lemma\-album/.test(i)});return g.length>0};this.isCrossParagraph=function(g){return g.search(f.Paragraph)>-1};this.isNeedSkip4Select=function(){return false}};var b=function(){var i={CrossParagraph:"\u8bf7\u4e0d\u8981\u8de8\u6bb5\u9009\u62e9\u3002",SpecailModel:"\u7279\u6b8a\u6a21\u5757\u6682\u4e0d\u5f00\u653e\u6279\u6ce8\u3002",EmptyContent:" ",SpecialObjectInSelection:"\u9009\u4e2d\u5185\u5bb9\u5305\u542b\u56fe\u7247\uff0c\u8bf7\u91cd\u65b0\u9009\u62e9\u3002",Success:"\u6279\u6ce8\u6210\u529f\u3002"};var h={lemmaTitle:["\u8bcd\u6761\u540d\u4e0d\u89c4\u8303\u6216\u5df2\u5b58\u5728\u540c\u4e49\u8bcd\u6761"],catalogChapter:["\u4e00\u4e8c\u7ea7\u76ee\u5f55\u6df7\u7f16","\u7ae0\u8282\u5212\u5206\u4e0d\u5f53\u6216\u6807\u9898\u5f52\u7eb3\u4e0d\u6b63\u786e"],definition:["\u6982\u5ff5\u3001\u5b9a\u4e49\u7f3a\u5931\u6216\u4e0d\u51c6\u786e","\u6982\u5ff5\u3001\u5b9a\u4e49\u4fe1\u606f\u77db\u76fe"],mainContent:["\u6dfb\u52a0\u65e0\u6548\u4fe1\u606f\u6216\u5220\u9664\u4e86\u6709\u6548\u4fe1\u606f","\u53d9\u8ff0\u91cd\u5fc3\u504f\u79bb\u4e3b\u9898\u6216\u8bcd\u6761\u8981\u7d20\u4fe1\u606f\u4e0d\u5b8c\u6574","\u975e\u7b2c\u4e09\u65b9\u5ba2\u89c2\u8868\u8ff0\uff0c\u542b\u6709\u7acb\u573a\u6216\u65f6\u6548\u6027\u63aa\u8f9e","\u6b63\u6587\u4fe1\u606f\u542b\u4e0d\u89c4\u8303\u6807\u70b9\u3001\u6587\u5b57\u6216\u4e71\u7801\u7b49","\u6b63\u6587\u5185\u5bb9\u5b58\u5728\u8868\u610f\u91cd\u590d"],pic:["\u56fe\u7247\u8d28\u91cf\u4f4e\u6216\u4e0e\u4e3b\u9898\u5173\u8054\u6027\u8f83\u5dee","\u56fe\u7247\u65e0\u6ce8\u91ca\u6216\u6ce8\u91ca\u4e0d\u51c6\u786e"],referenceData:["\u53c2\u8003\u8d44\u6599\u4e0e\u4e3b\u9898\u65e0\u5173","\u53c2\u8003\u8d44\u6599\u4e3a\u65e0\u6548\u94fe\u63a5","\u53c2\u8003\u8d44\u6599\u4e3a\u4e0d\u63a8\u8350\u4f7f\u7528\u7684\u94fe\u63a5"],composing:["\u7248\u9762\u4fe1\u606f\u5206\u5e03\u7410\u788e\u6216\u56fe\u6587\u6392\u7248\u4e0d\u4f73","\u65e0\u6392\u7248\u6216\u9519\u8bef\u4f7f\u7528\u7f16\u8f91\u529f\u80fd"]};var g=new e();var f=this;this.isValidSelection=function(l){var m=l.getSelection();var k=m.toHtml();var j=m.getRangeAt(0);var n=j.startContainer;var n=!n.tagName?n.parentNode:n;if(d.trim(k).length<=0){return i.EmptyContent}if(g.isCrossParagraph(k)){return i.CrossParagraph}if(!g.isInValidContainer(n)||g.isInHead(n)||g.isIncludeImage(j)||g.isNeedSkip4Select()){return i.SpecailModel}return""};this.getBaseInfoNode=function(k){var l=d(".baseInfoWrap .baseInfoLeft");var j=d(".baseInfoWrap .baseInfoRight");if(l.html().replace(/\&nbsp;/g,"").indexOf(k)>-1){return l}else{return j}};this.getContentType=function(j){j=d(!j.tagName?j.parentNode:j);if(j.parents(".card-summary-content").length>0||j.hasClass("card-summary-content")){return 1}else{if(j.parents(".baseInfoWrap").length>0||j.hasClass("baseInfoWrap")){return 2}else{if(j.parents(".lemma-main-content").length>0||j.hasClass("lemma-main-content")){return 3}else{return -1}}}};this.getRoot=function(k){k=d(!k.tagName?k.parentNode:k);var l=["card-summary-content","baseInfoLeft","baseInfoRight","para"];for(var j=0;j<l.length;j++){if(k.parents("."+l[j]).length>0){return k.parents("."+l[j])[0]}if(k.hasClass(l[j])){return k[0]}}return null};this.getParagraphIndex=function(m){var j=this.getRoot(m);if(!j){return -1}j=d(j);if(j.hasClass("para")){var k=d(".lemma-main-content").find(".para");for(var l=0;l<k.length;l++){if(j[0]==k[l]){return l}}}else{if(j.hasClass("baseInfoLeft")){return 0}else{if(j.hasClass("baseInfoRight")){return 1}else{if(j.hasClass("card-summary-content")){return 0}}}}return -1};this.getParagraph=function(k){var j=d("div.para").eq(k);return j};this.getComment=function(p){var m=p.qType;var j="";for(var o in m){for(var l=0;l<m[o].length;l++){var n=parseInt(m[o][l]);if(!!h[o]&&!!h[o][n]){j+=(h[o][n]+"<br>")}}}if(p.mentorComment!=""){j+=p.mentorComment}return j}};a=b;return a},["/static/common/ui/jquery/jquery.js"]);F.module("/static/widget/lemma/history/notation/notationItem.js",function(b,a){var c=b("/static/common/ui/jquery/jquery.js");var d=function(i,e){var h={editable:false,startContainer:null,endContainer:null,startOffset:-1,endOffset:-1,content:null,notationId:0,position:c(document.body).width()/2+1024/2-120};var f={notationLine:null,notationComment:null,highlightTag:null,positionTag:null};var o={handleAdd:null,handleUpdate:null,handleDelete:null};c.extend(h,i);c.extend(o,e);var p=this;var l=null;var k=null;var j=function(){m();n()};var n=function(r){var q=c(".notation-tag-"+h.notationId);if(q.length<=0){return}f.positionTag=c("<span></span>").insertAfter(q.eq(q.length-1));var s=f.positionTag.offset();f.notationLine=c('<hr class="notation-line"/>').css({top:s.top+"px",left:s.left+"px",width:(h.position-s.left)+"px"}).appendTo(c(document.body));f.notationComment=c('<div class="notation-comment">'+(h.editable?'<span class="edit"></span><span class="del"></span>':"")+'<div class="content">\u4fee\u6539\u5efa\u8bae<p>'+h.content.replace(/(\r\n)|(\n)/g,"<br/>")+"</p></div>  </div>").css({top:s.top+"px",left:h.position+"px"}).appendTo(c(document.body));!!h.editable&&f.notationComment.click(function(t){var u=c(t.target);if(u.hasClass("del")){o.handleDelete(p,function(){p.remove()})}else{if(u.hasClass("edit")){o.handleUpdate(p,function(v){h.content=v;f.notationComment.find("p").html(v.replace(/(\r\n)|(\n)/g,"<br/>"))})}}});!!o.handleAdd&&o.handleAdd(p,function(){})};this.getNotationId=function(){return h.notationId};this.getNotationContent=function(){return h.content};this.remove=function(){f.notationLine.remove();f.notationComment.remove();f.positionTag.remove();g();k=null;l=null};this.update=function(q){f.notationComment.find("p").text(q)};var m=function(){l=rangy.createCssClassApplier("notation-text notation-tag-"+h.notationId,{elementTagName:"em"});k=rangy.createRange();k.setStart(h.startContainer,h.startOffset);k.setEnd(h.endContainer,h.endOffset);l.applyToRange(k)};var g=function(){l.undoToRange(k)};j()};d.getRealContainer=function(e,i,k){var f=e.childNodes;var h=0;var g={container:null,offset:-1};while(!!f&&h<f.length){if(k+d.getText(f[h]).length>=i){if(f[h].nodeType==3){g.container=f[h];g.offset=i-k;return g}else{var j=d.getRealContainer(f[h],i,k);if(!!j){return j}else{k+=d.getText(f[h]).length}}}else{k+=d.getText(f[h]).length}h++}return null};d.convertToReal=function(g,f,i){var j=d.getRealContainer(g,f,0);var e=d.getRealContainer(g,i,0);if(!j||!j.container||!e||!e.container){return null}var h=!!h?h:{startContainer:j.container,endContainer:e.container,startOffset:j.offset,endOffset:e.offset};return h};d.getVirtualContainer=function(k,j,l,e){var f=e.childNodes;var h=0;var g=!!g?g:{container:null,offset:-1};while(!!f&&h<f.length){if(f[h]==k){g.container=f[h];g.offset=l+j;return g}else{var i=d.getVirtualContainer(k,j,l,f[h]);if(!!i){return i}else{l+=d.getText(f[h]).length}}h++}return null};d.convertToVirtual=function(k,g,f,j,h){var l=d.getVirtualContainer(k,f,0,h);var e=d.getVirtualContainer(g,j,0,h);if(!l||!e){return null}var i={container:h,offset:l.offset,len:e.offset-l.offset};return i};d.create=function(g,e){var h=d.convertToReal(g.rootNode,g.offset,g.offset+g.len);if(!h){return null}c.extend(g,h);var f=new d(g,e);f.virtual=g;return f};d.getText=function(e){if(typeof e.textContent!="undefined"&&e.textContent!=null){return e.textContent}else{if(typeof e.innerText!="undefined"&&e.innerText!=null){return e.innerText}else{if(typeof e.nodeValue!="undefined"&&e.nodeValue!=null){return e.nodeValue}}}return""};a=d;return a},["/static/common/ui/jquery/jquery.js"]);F.module("/static/widget/lemma/history/notation/notationService.js",function(c,b){var d=c("/static/common/ui/jquery/jquery.js");var a=function(g){var e={GetNotation:"/api/wikitask/tasklemma?method=getguidecomments",PostNotation:"/ajax/task/editguidecomments"};var f={lemmaId:"",versionId:"",commentType:1,subVersionId:"",tagNum:"5",userId:"",qType:""};d.extend(f,g);this.getNotation=function(i,h){d.ajax({url:e.GetNotation,dataType:"json",data:i,type:"POST",success:function(j){h.success(j)},error:function(){h.error("\u5bf9\u4e0d\u8d77\uff0c\u6dfb\u52a0\u5931\u8d25\uff0c\u8bf7\u7a0d\u540e\u518d\u8bd5\uff01")}})};this.postNotation=function(i,h){d.ajax({url:e.PostNotation+"?r="+Math.random(),dataType:"json",data:i,type:"POST",success:function(j){if(j.errno==0){h.success(j)}else{h.error("\u5bf9\u4e0d\u8d77\uff0c\u6dfb\u52a0\u5931\u8d25\uff0c\u8bf7\u7a0d\u540e\u518d\u8bd5\uff01")}},error:function(){h.error("\u5bf9\u4e0d\u8d77\uff0c\u6dfb\u52a0\u5931\u8d25\uff0c\u8bf7\u7a0d\u540e\u518d\u8bd5\uff01")}})};this.addNotation=function(j,h){var i=d.extend(j,f);d.extend(i,{act:"0"});this.postNotation(i,h)};this.deleteNotation=function(j,h){var i=d.extend(j,f);d.extend(i,{act:"2"});this.postNotation(i,h)};this.updateNotation=function(j,h){var i=d.extend(j,f);d.extend(i,{act:"1"});this.postNotation(i,h)}};b=a;return b},["/static/common/ui/jquery/jquery.js"]);F.module("/static/widget/lemma/history/notation/notationDialog.js",function(d,c){var e=d("/static/common/ui/jquery/jquery.js");var b=d("/static/common/ui/dialog/dialog.js");var a=function(){var k=['<div class="notation-dialog">','<textarea id="notation-dialog-input" style="width:545px;height:175px;" class="comment">$content$</textarea>',"</div>"].join("");var h=this;var i=null;var g=null;var j=null;var f=function(){i=new b({contentText:k,titleText:"\u6dfb\u52a0\u6279\u6ce8",width:550,height:200,autoRender:true,classPrefix:"bkdialog",autoDispose:false,buttons:{accept:{content:"\u786e\u8ba4",onclick:function(){var l=e("#notation-dialog-input").val();!!g&&g(l);i.close()}},cancel:{content:"\u53d6\u6d88",onclick:function(){!!j&&j();i.close()}}}})};this.display=function(n,m,l){if(!i){f()}e("#notation-dialog-input").val(m);g=l.handleCommit;j=l.handleCancel;i.open()}};c=new a();return c},["/static/common/ui/jquery/jquery.js","/static/common/ui/dialog/dialog.js"]);F.module("/static/widget/lemma/history/notation/notationView.js",function(c,b){var d=c("/static/common/ui/jquery/jquery.js");var e=c("/static/widget/lemma/history/notation/notationItem.js");var a=c("/static/widget/lemma/history/notation/notationDialog.js");var g=function(){var j=null;var h=function(){j=d('<div class="notation-bubble" style="display:none;"></div>').appendTo(d(document.body))};var i=function(l){j.css({top:l.top,left:l.left}).text(l.content).show()};var k=function(){j.hide()};this.show=function(l){i(l);setTimeout(function(){k()},1000)};h()};var f=function(j,h){var i={editable:false};var p={handleAdd:null,handleUpdate:null,handleDelete:null};d.extend(i,j);d.extend(p,h);var m=d('<em class="notation-icon" style="display:none;"></em>').appendTo(d(document.body));var n=new g();var q=this;var l=[];var k=function(){!!i.editable&&m.click(function(){a.display("\u6dfb\u52a0\u6279\u6ce8","",{handleCommit:function(r){if(!r||d.trim(r)==""){q.hideIcon();return}p.handleAdd({range:m.range,content:r});m.range=null;q.hideIcon()},handleCancel:function(){q.hideIcon()}})})};this.displayIcon=function(r){m.css({top:r.top,left:r.left+20}).show();m.range=r.range};this.hideIcon=function(){m.hide()};this.displayBubble=function(r){n.show(r)};this.hideBubble=function(){n.hide()};this.addSummaryNotation=function(s){var r=d('<div class="version-suggestion"><div class="title">\u7efc\u5408\u610f\u89c1\uff1a</div><div class="content">'+s.content+'</div><div class="auditor">\u8bc4\u5ba1\u5b98\uff1a'+s.author+'<a href="http://msg.baidu.com/msg/writing?receiver='+s.author+'" class="sixin" target="_blank">\u8bf7\u6559Ta</a></div>');r.insertBefore(s.container)};this.addNotation=function(r){e.create(r,{handleAdd:function(s,t){l.push(s);d(document.body).trigger("notation-update",l.length)},handleUpdate:p.handleUpdate,handleDelete:function(t,u){var s=function(){o(t);!!u&&u()};!!p.handleDelete&&p.handleDelete(t,s)}})};var o=function(s){for(var r=0;r<l.length;r++){if(l[r].getNotationId()==s.getNotationId()){l.splice(r,0)}}d(document.body).trigger("notation-update",l.length)};k()};b=f;return b},["/static/common/ui/jquery/jquery.js","/static/widget/lemma/history/notation/notationItem.js","/static/widget/lemma/history/notation/notationDialog.js"]);F.module("/static/widget/lemma/history/notation/notation.js",function(b,e){var f=b("/static/common/ui/jquery/jquery.js");var d=b("/static/common/ui/rangy/rangy.js");var j=b("/static/widget/lemma/history/notation/notationLogic.js");var h=b("/static/widget/lemma/history/notation/notationItem.js");var a=b("/static/widget/lemma/history/notation/notationService.js");var c=b("/static/widget/lemma/history/notation/notationView.js");var i=b("/static/widget/lemma/history/notation/notationDialog.js");var g=function(o){var m={lemmaId:0,subLemmaId:0,versionId:0,subVersionId:0,commitId:0,authorId:0,editable:false,isUserAudit:false};f.extend(m,o);var n=new j();var w=this;var s=null;var t=null;var p=function(C){var B=C.comments;q(C);for(var A=0;A<B.length;A++){var z=B[A].paragNum;var y=B[A].contentType+""=="1"?f(".card-summary-content"):f("#lemmaContent-0").find(".para").eq(z);var x=parseInt(B[A].offset);if(!y||y.length<=0){return}if(B[A].contentType+""=="10"){continue}if(B[A].contentType+""=="2"){y=n.getBaseInfoNode(B[A].content)}t.addNotation({rootNode:y[0],offset:x,paraIndex:z,len:parseInt(B[A].len),selectContent:B[A].content,content:n.getComment(B[A]),notationId:B[A].commentId,contentType:B[A].contentType,editable:m.editable})}};var q=function(A){var z=A.comments;var y="\u65e0\u7efc\u5408\u610f\u89c1\uff0c\u8bf7\u67e5\u770b\u8bcd\u6761\u4e2d\u7684\u6279\u6ce8\u3002";for(var x=0;x<z.length;x++){if(z[x].contentType+""=="10"){y=z[x].mentorComment;break}}t.addSummaryNotation({content:y,author:A.auditName,container:f("#content")})};var l=function(){s.getNotation({commitId:m.commitId},{success:function(x){if(!x){return}m.editable=(x.errno==0&&!y&&m.isUserAudit);if(!t){t=new c({editable:m.editable},{handleDelete:u,handleUpdate:k,handleAdd:r})}var y=!!x.data&&!!x.data.comments&&x.data.comments.length>0;if(y){p(x.data)}!!m.editable&&v()},error:function(x){}})};var v=function(){f("#sec-content0").bind("mouseup",function(y){t.hideIcon();var x=n.isValidSelection(rangy);if(x===""){t.displayIcon({top:y.pageY,left:y.pageX,range:rangy.getSelection().getRangeAt(0)})}else{if(f.trim(x)){t.displayBubble({top:y.pageY,left:y.pageX,content:x})}}})};var u=function(x,y){s.deleteNotation({commentId:x.getNotationId()},{success:function(){y()},error:function(z){alert(z)}})};var k=function(x,y){i.display("\u4fee\u6539\u6279\u6ce8",x.getNotationContent(),{handleCommit:function(z){if(!z||f.trim(z)==""){return}s.updateNotation({commentId:x.getNotationId(),contentType:x.virtual.contentType,paragNum:x.virtual.paraIndex,offset:x.virtual.offset,len:x.virtual.len,content:x.virtual.selectContent,mentorComment:z},{success:function(A){y(z)},error:function(A){alert(A)}})}})};var r=function(C){var A=C.range.startContainer;var B=C.range.toString();var x=n.getRoot(A);var z=n.getParagraphIndex(A);var D=n.getContentType(A);if(!x){return}var y=h.convertToVirtual(A,C.range.endContainer,C.range.startOffset,C.range.endOffset,x);if(!y){return}s.addNotation({contentType:D,paragNum:z,offset:y.offset,len:y.len,content:B,mentorComment:C.content},{success:function(E){t.addNotation({rootNode:x,paraIndex:z,offset:y.offset,len:y.len,selectContent:B,content:C.content,notationId:E.commentId,contentType:D,editable:m.editable})},error:function(E){alert(E)}})};this.initialize=function(){rangy.init();s=new a({lemmaId:m.lemmaId,versionId:m.versionId,subVersionId:m.subVersionId,userId:m.authorId});l()}};e=g;return e},["/static/common/ui/jquery/jquery.js","/static/common/ui/rangy/rangy.js","/static/widget/lemma/history/notation/notationLogic.js","/static/widget/lemma/history/notation/notationItem.js","/static/widget/lemma/history/notation/notationService.js","/static/widget/lemma/history/notation/notationView.js","/static/widget/lemma/history/notation/notationDialog.js"]);